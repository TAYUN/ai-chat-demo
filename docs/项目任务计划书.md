# AI 对话服务器demo - 项目任务计划书

## 项目概述

本项目旨在结合 AdonisJS 和 Vue.js，通过 WebSocket 和 Server-Sent Events (SSE) 技术实现模拟 AI 对话的"打字机"效果。这是一个学习型项目demo，帮助你掌握实时通信技术的实际应用。

## 技术栈

- **后端**: AdonisJS v6
- **前端**: Vue 3 (需要初始化)
- **实时通信**: WebSocket + SSE
- **数据库**: MySQL
- **语言**: TypeScript

## 项目目标

1. 实现 WebSocket 双向通信（用于实时聊天）
2. 实现 SSE 单向流式响应（用于 AI 打字机效果）
3. 创建简单的 Vue 前端界面
4. 模拟 AI 响应的流式输出

---

## 阶段一：服务端基础架构搭建

### 任务 1.1: 创建消息模型

**目标**: 创建数据库表和模型来存储聊天消息

**步骤**:
1. 创建迁移文件
   ```bash
   node ace make:migration create_messages_table
   ```
2. 定义表结构：
   - `id` - 主键
   - `user_id` - 用户 ID（外键）
   - `role` - 消息角色（'user' | 'assistant'）
   - `content` - 消息内容
   - `created_at` - 创建时间
   - `updated_at` - 更新时间
3. 创建模型文件
   ```bash
   node ace make:model Message
   ```
4. 运行迁移
   ```bash
   node ace migration:run
   ```

**验证**: 检查数据库中是否成功创建 `messages` 表

---

### 任务 1.2: 创建控制器

**目标**: 创建处理消息请求的控制器

**步骤**:
1. 创建聊天控制器
   ```bash
   node ace make:controller ChatsController
   ```
2. 实现基础方法：
   - `index()` - 获取消息历史
   - `store()` - 保存用户消息
   - `stream()` - SSE 流式响应接口

**文件位置**: `app/controllers/chats_controller.ts`

---

### 任务 1.3: 配置路由

**目标**: 定义 API 路由

**步骤**:
在 `start/routes.ts` 中添加路由：

```typescript
const ChatsController = () => import('#controllers/chats_controller')

router.group(() => {
  router.get('/messages', [ChatsController, 'index'])
  router.post('/messages', [ChatsController, 'store'])
  router.get('/stream', [ChatsController, 'stream'])
}).prefix('api')
```

**验证**: 访问 `http://localhost:3333/api/messages` 应返回空数组

---

## 阶段二：SSE 实现（打字机效果）

### 任务 2.1: 实现 SSE 流式响应

**目标**: 创建 SSE 接口返回模拟 AI 响应

**步骤**:
1. 在控制器中实现 `stream()` 方法
2. 设置正确的 SSE 响应头：
   ```typescript
   response.header('Content-Type', 'text/event-stream')
   response.header('Cache-Control', 'no-cache')
   response.header('Connection', 'keep-alive')
   ```
3. 实现逐字/逐段发送消息逻辑
4. 模拟 AI 响应延迟

**文件位置**: `app/controllers/chat_controller.ts`

**关键代码示例**:
```typescript
async stream({ response }: HttpContext) {
  response.header('Content-Type', 'text/event-stream')
  response.header('Cache-Control', 'no-cache')
  response.header('Connection', 'keep-alive')

  const message = "这是一个模拟的 AI 响应，用于演示打字机效果..."

  for (const char of message) {
    response.send(`data: ${char}\n\n`)
    await new Promise(resolve => setTimeout(resolve, 50))
  }

  response.send('data: [DONE]\n\n')
}
```

**验证**: 使用 curl 测试
```bash
curl -N http://localhost:3333/api/stream
```

---

### 任务 2.2: 创建 AI 模拟服务

**目标**: 创建服务层模拟 AI 响应逻辑

**步骤**:
1. 创建 AI 服务
   ```bash
   node ace make:service AIService
   ```
2. 实现生成响应的方法
3. 支持多种响应模式：
   - 打字机模式（逐字发送）
   - 批量模式（分段发送）
   - 完整模式（一次性发送）

**文件位置**: `app/services/ai_service.ts`

---

## 阶段三：Socket.io 实现（实时通信）

### 任务 3.1: 安装与配置 Socket.io

**目标**: 在 AdonisJS v6 中集成 Socket.io

**步骤**:
1. 安装依赖
   ```bash
   pnpm add socket.io
   ```
2. 创建 Socket 服务 (单例模式)
   - 负责初始化 Socket.io Server
   - 管理连接实例
3. 创建启动文件 `start/ws.ts`
   - 在应用启动时加载 Socket 服务
4. 配置 `adonisrc.ts`
   - 添加 `start/ws` 到 preloads

**文件位置**:
- `app/services/ws.ts`
- `start/ws.ts`

**验证**: 启动服务，控制台无报错，且能看到 Socket.io 启动日志

---

### 任务 3.2: 实现 WebSocket 逻辑

**目标**: 处理 Socket 连接和消息

**步骤**:
1. 在 `start/ws.ts` 中定义事件监听：
   - `connection` - 处理新连接
   - `disconnect` - 处理断开
2. 实现消息处理：
   - 监听客户端 `client_message` 事件
   - 调用 AI 服务生成响应
   - 通过 `server_message` 事件发回响应

**关键功能**:
- 接收客户端消息
- 模拟 AI 响应
- 将 AI 响应推送给客户端

---

### 任务 3.3: 完善聊天逻辑 (已完成)

**目标**: 完整的聊天功能实现

**步骤**:
1. 在 WebSocket 控制器中实现：
   - 用户消息接收和存储 (已完成)
   - AI 响应生成 (已完成)
   - 消息广播给所有客户端 (已完成)
   - 单独响应给特定客户端 (已完成)

2. 实现打字机效果：(已完成)
   - 将 AI 响应分多个包发送
   - 每个包间隔 50-100ms

**验证**: 使用 WebSocket 客户端工具测试连接和消息收发

---

## 阶段四：前端开发

### 任务 4.1: 初始化 Vue 项目 (已完成)

**目标**: 创建前端项目 (与 Server 端并列)

**步骤**:
1. 在父级目录创建 `ai-chat-client` 项目
   ```bash
   cd ..
   pnpm create vue@latest ai-chat-client
   ```
   选择配置：
   - TypeScript: Yes
   - Router: Yes
   - Pinia: Yes
   - ESLint: Yes

2. 进入项目并安装依赖
   ```bash
   cd ai-chat-client
   pnpm install
   ```

**目录结构**:
```
d:\code-my\ai-chat\
├── ai-chat-server/     # AdonisJS 后端
└── ai-chat-client/     # Vue 前端
    ├── src/
    │   ├── components/
    │   ├── views/
    │   ├── stores/
    │   └── main.ts
```
└── app/               # AdonisJS 后端
```

---

### 任务 4.2: 创建聊天界面组件 (已完成)

**目标**: 实现基本的聊天 UI

**步骤**:
1. 创建 `ChatMessage.vue` 组件 (已完成)
   - 显示单条消息
   - 区分用户和 AI 消息样式
   - 支持打字机动画效果

2. 创建 `ChatInput.vue` 组件 (已完成)
   - 消息输入框
   - 发送按钮
   - 支持回车发送

3. 创建 `ChatRoom.vue` 组件 (已完成)
   - 整合消息列表和输入框
   - 管理消息状态

**文件位置**: `frontend/src/components/`

---

### 任务 4.3: 实现 Socket.io 前端集成 (已完成)

**目标**: 前端连接 Socket.io 接口接收实时数据

**步骤**:
1. 安装 socket.io-client (已完成)
2. 在 ChatRoom 组件中集成 Socket.io (已完成)
   - 连接服务器
   - 监听 `server_message`
   - 发送 `client_message`
   - 处理多端同步 `user_sync`

**验证**: 在前端发送消息，看到打字机效果

---

### 任务 4.4: 实现 WebSocket 前端集成 (已合并至 4.3)

**备注**: 由于采用了 Socket.io 方案，本任务已合并至 4.3。

**验证**: 打开多个浏览器窗口，测试实时消息同步 (已完成)

---

### 任务 4.5: 添加状态管理 (已完成)

**目标**: 使用 Pinia 管理聊天状态

**步骤**:
1. 创建聊天 store (已完成)
2. 创建 `useChatStore` (已完成)
3. 在组件中使用 store (已完成)

---

## 阶段五：功能完善与测试

### 任务 5.1: 添加错误处理 (已完成)

**目标**: 完善前后端错误处理机制

**后端**:
1. 捕获 WebSocket 连接错误 (已完成)
2. 捕获 SSE 连接中断
3. 添加友好的错误响应 (已完成)

**前端**:
1. 显示连接状态 (已完成)
2. 显示错误提示 (已完成)
3. 实现自动重连机制 (Socket.io 内置支持)

---

### 任务 5.2: 添加消息持久化 (已完成)

**目标**: 保存聊天历史到数据库

**步骤**:
1. 保存用户消息到数据库 (已完成)
2. 保存 AI 响应到数据库 (已完成)
3. 实现历史消息加载功能 (已完成)
4. 添加清除历史功能 (已完成)

---

### 任务 5.3: 添加身份验证（已完成）

**目标**: 简单的用户认证

**步骤**:
1. 使用现有的 Auth 模块（已完成）
2. 创建登录/注册页面（已完成）
3. 关联消息到用户（已完成）
4. 实现用户专属聊天记录（已完成）

---

### 任务 5.4: 性能优化

**目标**: 优化实时通信性能

**优化点**:
1. 消息分页加载
2. 消息虚拟滚动
3. 连接池管理
4. 响应压缩

---

### 任务 5.5: 测试

**目标**: 全面测试功能

**测试清单**:
- [ ] SSE 流式响应正常
- [ ] WebSocket 连接稳定
- [ ] 消息发送和接收正确
- [ ] 打字机效果流畅
- [ ] 多客户端同时在线
- [ ] 错误处理正确
- [ ] 数据持久化成功
- [ ] 前后端联调无误

---

## 阶段六：部署准备

### 任务 6.1: 环境配置

**目标**: 配置不同环境

**步骤**:
1. 创建 `.env.production` 文件
2. 配置生产环境变量
3. 配置 CORS 策略

---

### 任务 6.2: 构建优化

**目标**: 优化生产构建

**后端**:
```bash
node ace build --production
```

**前端**:
```bash
cd frontend
pnpm build
```

---

### 任务 6.3: 部署文档

**目标**: 编写部署说明

**内容**:
1. 服务器要求
2. 环境变量配置
3. 构建步骤
4. 启动命令
5. 常见问题

---

## 学习目标达成检查

完成本项目后，你应该掌握：

✅ AdonisJS 框架基础使用
✅ WebSocket 实时通信原理和实现
✅ SSE 流式数据传输
✅ Vue 3 组合式 API 使用
✅ Pinia 状态管理
✅ 前后端实时数据交互
✅ 打字机效果实现技巧
✅ 错误处理和连接管理
✅ TypeScript 类型安全编程

---

## 常见问题与解决方案

### Q1: SSE 连接超时怎么办？
A: 设置合适的超时时间，或使用心跳机制保持连接。

### Q2: 如何实现 AI 真实响应？
A: 集成 OpenAI API 或其他 LLM 服务，替换模拟逻辑。

### Q3: WebSocket 连接不稳定？
A: 实现自动重连机制，添加心跳检测。

### Q4: 前端如何显示打字机动画？
A: 使用 CSS 动画或 JavaScript 定时器逐字显示。

---

## 扩展功能建议

完成基础功能后，可以考虑：

1. **Markdown 支持**: 使用 `marked` 或 `markdown-it` 渲染 Markdown
2. **代码高亮**: 使用 `highlight.js` 或 `shiki`
3. **流式解析**: 实现 SSE 数据流解析和状态管理
4. **多模态支持**: 支持图片、文件等
5. **语音输入/输出**: 使用 Web Speech API
6. **主题切换**: 深色/浅色模式
7. **导出对话**: 导出为 PDF 或 Markdown
8. **实时协作**: 多用户同时编辑
9. **消息加密**: 端到端加密
10. **消息撤回**: 支持删除和编辑消息

---

## 参考资源

- [AdonisJS 官方文档](https://docs.adonisjs.com/)
- [Vue 3 官方文档](https://vuejs.org/)
- [MDN WebSocket 文档](https://developer.mozilla.org/zh-CN/docs/Web/API/WebSocket)
- [MDN SSE 文档](https://developer.mozilla.org/zh-CN/docs/Web/API/Server-sent_events)

---

## 项目进度追踪

使用以下表格追踪进度：

| 阶段 | 任务 | 状态 | 完成日期 | 备注 |
|------|------|------|----------|------|
| 一 | 1.1 消息模型 | ⬜ | | |
| 一 | 1.2 控制器 | ⬜ | | |
| 一 | 1.3 路由配置 | ⬜ | | |
| 二 | 2.1 SSE 实现 | ⬜ | | |
| 二 | 2.2 AI 服务 | ⬜ | | |
| 三 | 3.1 WebSocket 安装 | ⬜ | | |
| 三 | 3.2 WS 控制器 | ⬜ | | |
| 三 | 3.3 聊天逻辑 | ⬜ | | |
| 四 | 4.1 Vue 初始化 | ⬜ | | |
| 四 | 4.2 聊天组件 | ⬜ | | |
| 四 | 4.3 SSE 前端 | ⬜ | | |
| 四 | 4.4 WS 前端 | ⬜ | | |
| 四 | 4.5 状态管理 | ⬜ | | |
| 五 | 5.1 错误处理 | ⬜ | | |
| 五 | 5.2 消息持久化 | ⬜ | | |
| 五 | 5.3 身份验证 | ⬜ | | |
| 五 | 5.4 性能优化 | ⬜ | | |
| 五 | 5.5 测试 | ⬜ | | |
| 六 | 6.1 环境配置 | ⬜ | | |
| 六 | 6.2 构建优化 | ⬜ | | |
| 六 | 6.3 部署文档 | ⬜ | | |

**状态说明**:
- ⬜ 未开始
- 🟡 进行中
- 🟢 已完成
- 🔴 遇到问题

---

## 开始行动

准备好了吗？让我们从**阶段一，任务 1.1**开始！执行以下命令：

```bash
node ace make:migration create_messages_table
```

祝学习顺利！🚀
